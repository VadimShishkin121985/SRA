name: Automated API tests


on:
  workflow_dispatch:  # –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
  push:
    branches:
      - main
  pull_request:

jobs:
  api-test-job:
    name: Run API Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run API Tests
      run: |
        echo "Starting API tests..."
        python api/dt_api.py || { echo "‚ùå –û—à–∏–±–∫–∞ –≤ API —Ç–µ—Å—Ç–∞—Ö"; exit 1; }
        echo "‚úÖ API —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

    - name: Save test report
      if: always()  # –í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      uses: actions/upload-artifact@v4
      with:
        name: api-test-report
        path: ./api/test_results/  # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å —Ä–µ–ø–æ—Ä—Ç–æ–º (—Å–æ–∑–¥–∞—Ç—å –≤ dt_api.py)
        retention-days: 7

  publish-report:
    name: Publish Test Report
    runs-on: ubuntu-latest
    needs: api-test-job  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤

    steps:
    - name: Download test report artifact
      uses: actions/download-artifact@v4
      with:
        name: api-test-report
        path: ./downloaded_report/

    - name: Publish report
      run: |
        echo "üìÑ –¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç:"
        cat ./downloaded_report/report.txt || echo "‚ö†Ô∏è –û—Ç—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"